<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Carros</title>
    <link rel="icon" type="image/x-icon" href="imagens/car.ico">
    <link rel="shortcut icon" href="imagens/car.ico">
    <link rel="apple-touch-icon" href="imagens/car.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: #f8fafc;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        
        .status-urgent {
            background: #fef2f2;
            color: #991b1b;
            border-left: 4px solid #f87171;
        }
        
        .status-warning {
            background: #fffbeb;
            color: #92400e;
            border-left: 4px solid #fbbf24;
        }
        
        .status-ok {
            background: #f0fdf4;
            color: #166534;
            border-left: 4px solid #4ade80;
        }
        
        .status-neutral {
            background: #f8fafc;
            color: #475569;
            border-left: 4px solid #94a3b8;
        }
        
        .btn-primary {
            background: #e2e8f0;
            color: #475569;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #cbd5e1;
            transform: translateY(-1px);
        }
        
        .config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .confirm-modal.show {
            display: flex;
        }

        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fbbf24;
            color: #92400e;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 3000;
            max-width: 400px;
            border-left: 4px solid #f59e0b;
        }

        .email-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .email-enabled {
            background: #dcfce7;
            color: #166534;
        }

        .email-disabled {
            background: #fef2f2;
            color: #991b1b;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-4 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-full mb-3">
                <span class="text-2xl">üöó</span>
            </div>
            <h1 class="text-2xl font-bold text-slate-700 mb-2">Dashboard de Carros</h1>
            <p class="text-slate-500 text-sm">Gerencie os eventos dos seus ve√≠culos</p>
            <div id="emailStatus" class="mt-2">
                <span class="email-status email-disabled">üìß Email Autom√°tico: Desativado</span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center mb-8">
            <div class="glass-card rounded-2xl p-2 flex flex-wrap justify-center gap-2">
                <button id="dashboardBtn" onclick="showDashboard()" class="px-6 py-3 rounded-xl font-semibold transition-all duration-300 bg-slate-200 text-slate-700 shadow-sm">
                    üìä Dashboard
                </button>
                <button id="carsBtn" onclick="showCars()" class="px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100">
                    üöó Gerir Carros
                </button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView">
            <!-- Events Timeline -->
            <div class="glass-card rounded-3xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-slate-700 mb-8 flex items-center">
                    <span class="mr-4">üìÖ</span>
                    Pr√≥ximos Eventos
                </h2>
                <div id="eventsTimeline">
                    <!-- Events will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Email Configuration View -->
        <div id="emailConfigView" style="display: none;">
            <div class="glass-card rounded-3xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-slate-700 mb-8 flex items-center">
                    <span class="mr-4">üìß</span>
                    Configura√ß√£o de Email Autom√°tico
                </h2>
                
                <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 mb-8">
                    <div class="flex items-start space-x-4">
                        <div id="statusIcon" class="text-2xl">‚ùå</div>
                        <div class="flex-1">
                            <h3 id="statusText" class="font-semibold text-blue-800 mb-2">Email autom√°tico desativado</h3>
                            <p id="configDetails" class="text-blue-600 text-sm">Configure os campos abaixo para ativar o envio autom√°tico</p>
                        </div>
                    </div>
                </div>

                <form id="emailConfigForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Service ID</label>
                            <input type="text" id="serviceId" placeholder="service_xxxxxxx" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Template ID</label>
                            <input type="text" id="templateId" placeholder="template_xxxxxxx" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Public Key</label>
                        <input type="text" id="publicKey" placeholder="Sua chave p√∫blica do EmailJS" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300">
                            <span class="text-lg mr-2">üíæ</span>
                            Salvar Configura√ß√£o
                        </button>
                        <button type="button" onclick="testEmailConfig()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300">
                            <span class="text-lg mr-2">üß™</span>
                            Testar Configura√ß√£o
                        </button>
                    </div>
                </form>

                <div class="mt-8 p-6 bg-gray-50 rounded-2xl">
                    <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                        <span class="mr-2">‚ö°</span>
                        Teste R√°pido
                    </h3>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="email" id="quickTestEmail" placeholder="Digite um email para teste..." class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                        <button onclick="quickTestEmail()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 whitespace-nowrap">
                            <span class="mr-2">üì§</span>Enviar Teste
                        </button>
                    </div>
                </div>

                <div class="mt-8 p-6 bg-yellow-50 border border-yellow-200 rounded-2xl">
                    <h3 class="font-semibold text-yellow-800 mb-3">üìã Como Configurar:</h3>
                    <ol class="text-yellow-700 text-sm space-y-2 list-decimal list-inside">
                        <li>Acesse <a href="https://www.emailjs.com" target="_blank" rel="noopener noreferrer" class="underline hover:text-yellow-900">emailjs.com</a> e crie uma conta gratuita</li>
                        <li>Crie um novo servi√ßo de email (Gmail, Outlook, etc.)</li>
                        <li>Crie um template com as vari√°veis: to_email, subject, message</li>
                        <li>Copie o Service ID, Template ID e Public Key para os campos acima</li>
                        <li>Clique em "Salvar Configura√ß√£o" e teste o envio</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Configuration View -->
        <div id="configView" style="display: none;">
            <div class="glass-card rounded-3xl p-8">
                <h2 class="text-2xl font-bold text-slate-700 mb-8 flex items-center">
                    <span class="mr-4">‚öôÔ∏è</span>
                    Configura√ß√£o da Base de Dados
                </h2>
                
                <div class="bg-green-50 border border-green-200 rounded-2xl p-6 mb-8">
                    <div class="flex items-start space-x-4">
                        <div class="text-2xl">‚úÖ</div>
                        <div>
                            <h3 class="font-semibold text-green-800 mb-2">JSONBin configurado e funcionando</h3>
                            <p class="text-green-600 text-sm">Os dados s√£o automaticamente sincronizados na nuvem</p>
                        </div>
                    </div>
                </div>

                <form id="configForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">API Key do JSONBin</label>
                        <input type="password" id="apiKey" placeholder="$2a$10$..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        <p class="text-gray-500 text-sm mt-2">Chave de API para sincroniza√ß√£o autom√°tica dos dados</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Bin ID (opcional)</label>
                        <input type="text" id="binId" placeholder="68e4d92dd0ea881f40983660" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                        <p class="text-gray-500 text-sm mt-2">ID do bin existente (deixe vazio para criar novo)</p>
                    </div>
                    
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300">
                        <span class="text-lg mr-2">üíæ</span>
                        Salvar Configura√ß√£o
                    </button>
                </form>

                <div class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-2xl">
                    <h3 class="font-semibold text-blue-800 mb-3">üìã Como Configurar:</h3>
                    <ol class="text-blue-700 text-sm space-y-2 list-decimal list-inside">
                        <li>Acesse <a href="https://jsonbin.io" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-900">jsonbin.io</a> e crie uma conta gratuita</li>
                        <li>Gere uma API Key na sec√ß√£o "API Keys"</li>
                        <li>Cole a API Key no campo acima</li>
                        <li>Deixe o Bin ID vazio na primeira configura√ß√£o</li>
                        <li>O sistema criar√° automaticamente um novo bin para os seus dados</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Cars Management View -->
        <div id="carsView" style="display: none;">
            <!-- Add Car Form -->
            <div class="glass-card rounded-3xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-slate-700 mb-8 flex items-center">
                    <span class="mr-4">‚ûï</span>
                    Adicionar Novo Carro
                </h2>
                <form id="carForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Marca</label>
                        <input type="text" id="carBrand" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Ex: BMW, Mercedes, Toyota...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Modelo</label>
                        <input type="text" id="carModel" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Ex: X3, A4, C-Class">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Matr√≠cula</label>
                        <input type="text" id="licensePlate" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Ex: 12-AB-34">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Email para Alertas</label>
                        <input type="email" id="alertEmail" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="exemplo@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Pr√≥xima Inspe√ß√£o</label>
                        <input type="date" id="inspectionDate" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Vencimento do Seguro</label>
                        <input type="date" id="insuranceDate" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Pagamento do IUC</label>
                        <input type="date" id="iucDate" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Logo da Marca (opcional)</label>
                        <div class="space-y-3">
                            <input type="url" id="logoUrl" placeholder="https://exemplo.com/logo.png" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                            <div class="flex items-center space-x-3">
                                <input type="file" id="brandLogo" accept="image/*" class="hidden">
                                <button type="button" onclick="document.getElementById('brandLogo').click()" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-purple-300 transition-all duration-200 text-gray-600 hover:text-purple-600 font-medium">
                                    üì∑ Ou Selecionar Ficheiro
                                </button>
                                <div id="logoPreview" class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-xs">
                                    Logo
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full btn-primary text-indigo-800 font-semibold py-4 px-6 rounded-xl">
                            <span class="text-lg mr-2">üöó</span>
                            Adicionar Carro
                        </button>
                    </div>
                </form>
            </div>

            <!-- Cars List -->
            <div id="carsList" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                <!-- Cars will be displayed here -->
            </div>
        </div>



        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20">
            <div class="inline-flex items-center justify-center w-32 h-32 bg-white/20 rounded-full mb-8">
                <span class="text-6xl">üöó</span>
            </div>
            <h3 class="text-2xl font-bold text-slate-700 mb-4">Nenhum carro registado</h3>
            <p class="text-slate-500 text-lg mb-8">Comece adicionando o seu primeiro ve√≠culo</p>
            <button onclick="showCars()" class="btn-primary font-semibold py-4 px-8 rounded-xl">
                <span class="text-lg mr-2">‚ûï</span>
                Adicionar Primeiro Carro
            </button>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="confirm-modal">
            <div class="glass-card rounded-3xl p-8 max-w-md mx-4">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                        <span class="text-3xl">üóëÔ∏è</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-700 mb-2">Eliminar Carro</h3>
                    <p class="text-slate-500" id="confirmMessage">Tem a certeza que deseja eliminar este carro?</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="cancelDelete()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                        Cancelar
                    </button>
                    <button onclick="confirmDelete()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cars = JSON.parse(localStorage.getItem('cars')) || [];
        let config = JSON.parse(localStorage.getItem('config')) || {
            apiKey: '$2a$10$p2B6kIgO16ed1z49Jr3RNeVTN0uabdyVXVjlSsqctFLPfxeuymD.u',
            binId: '68e4d92dd0ea881f40983660'
        };

        // EmailJS Configuration - Configura√ß√£o integrada para testes
        let emailConfig = JSON.parse(localStorage.getItem('emailConfig')) || {
            serviceId: 'service_d34nyfr',
            templateId: 'template_sqi1nbq',
            publicKey: '3OUBFn_u0ezzG0otC',
            enabled: false
        };

        // Auto-enable if all fields are configured
        if (emailConfig.serviceId && emailConfig.templateId && emailConfig.publicKey && emailConfig.publicKey !== 'YOUR_EMAILJS_PUBLIC_KEY_HERE') {
            emailConfig.enabled = true;
            localStorage.setItem('emailConfig', JSON.stringify(emailConfig));
        }
        
        // Force enable with the new configuration
        emailConfig.enabled = true;
        localStorage.setItem('emailConfig', JSON.stringify(emailConfig));

        // Initialize EmailJS
        function initEmailJS() {
            if (emailConfig.publicKey && emailConfig.enabled) {
                emailjs.init(emailConfig.publicKey);
                console.log('EmailJS initialized successfully');
                updateEmailStatus(true);
            } else {
                updateEmailStatus(false);
            }
        }

        function updateEmailStatus(enabled) {
            const statusElement = document.getElementById('emailStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const configDetails = document.getElementById('configDetails');
            
            if (enabled && emailConfig.serviceId && emailConfig.templateId && emailConfig.publicKey) {
                statusElement.innerHTML = '<span class="email-status email-enabled">üìß Email Autom√°tico: Ativado</span>';
                if (statusIcon) statusIcon.textContent = '‚úÖ';
                if (statusText) statusText.textContent = 'Email autom√°tico ativado e funcionando';
                if (configDetails) configDetails.textContent = `Service: ${emailConfig.serviceId} | Template: ${emailConfig.templateId}`;
            } else {
                statusElement.innerHTML = '<span class="email-status email-disabled">üìß Email Autom√°tico: Desativado</span>';
                if (statusIcon) statusIcon.textContent = '‚ùå';
                if (statusText) statusText.textContent = 'Email autom√°tico desativado';
                if (configDetails) configDetails.textContent = 'Configure os campos acima para ativar o envio autom√°tico';
            }
        }

        function showEmailConfig() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('carsView').style.display = 'none';
            document.getElementById('emailConfigView').style.display = 'block';
            document.getElementById('configView').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            // Update button states
            document.getElementById('dashboardBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            document.getElementById('carsBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            document.getElementById('emailBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 bg-slate-200 text-slate-700 shadow-sm';
            document.getElementById('configBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            
            // Load current config
            document.getElementById('serviceId').value = emailConfig.serviceId || '';
            document.getElementById('templateId').value = emailConfig.templateId || '';
            document.getElementById('publicKey').value = emailConfig.publicKey || '';
            
            updateEmailStatus(emailConfig.enabled);
        }

        function showConfig() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('carsView').style.display = 'none';
            document.getElementById('emailConfigView').style.display = 'none';
            document.getElementById('configView').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            // Update button states
            document.getElementById('dashboardBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            document.getElementById('carsBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            document.getElementById('emailBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            document.getElementById('configBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 bg-slate-200 text-slate-700 shadow-sm';
            
            // Load current config
            document.getElementById('apiKey').value = config.apiKey || '';
            document.getElementById('binId').value = config.binId || '';
        }

        document.getElementById('emailConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            emailConfig.serviceId = document.getElementById('serviceId').value.trim();
            emailConfig.templateId = document.getElementById('templateId').value.trim();
            emailConfig.publicKey = document.getElementById('publicKey').value.trim();
            emailConfig.enabled = !!(emailConfig.serviceId && emailConfig.templateId && emailConfig.publicKey);
            
            localStorage.setItem('emailConfig', JSON.stringify(emailConfig));
            
            if (emailConfig.enabled) {
                initEmailJS();
                showNotification('‚úÖ Email autom√°tico ativado com sucesso!', 'info');
            } else {
                showNotification('‚ùå Preencha todos os campos para ativar', 'warning');
            }
            
            updateEmailStatus(emailConfig.enabled);
        });

        document.getElementById('configForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            config.apiKey = document.getElementById('apiKey').value.trim();
            config.binId = document.getElementById('binId').value.trim();
            
            localStorage.setItem('config', JSON.stringify(config));
            
            showNotification('‚úÖ Configura√ß√£o da BD salva com sucesso!', 'info');
            
            // Test the configuration by trying to save current data
            if (config.apiKey) {
                saveToJSONBin(cars);
            }
        });

        function testEmailConfig() {
            if (!emailConfig.enabled || !emailConfig.serviceId || !emailConfig.templateId || !emailConfig.publicKey) {
                showNotification('‚ùå Configure primeiro todos os campos!', 'warning');
                return;
            }

            const testEmail = prompt('Digite um email para teste:');
            if (!testEmail) return;

            const testData = {
                to_email: testEmail,
                subject: 'üß™ Teste - Sistema de Alertas de Carros',
                message: `Este √© um email de teste do seu sistema de gest√£o de carros.

Se recebeu este email, significa que a configura√ß√£o est√° funcionando perfeitamente! ‚úÖ

O sistema ir√° agora enviar alertas autom√°ticos para:
- Inspe√ß√µes pr√≥ximas do vencimento
- Seguros a expirar  
- Pagamentos de IUC em atraso

Configura√ß√£o testada em: ${new Date().toLocaleString('pt-PT')}

Sistema de Gest√£o de Carros`
            };

            sendEmailViaEmailJS(testData)
                .then(() => {
                    showNotification('‚úÖ Email de teste enviado! Verifique a caixa de entrada.', 'info');
                })
                .catch((error) => {
                    showNotification('‚ùå Erro no teste. Verifique a configura√ß√£o.', 'warning');
                    console.error('Test email error:', error);
                });
        }

        function quickTestEmail() {
            const emailInput = document.getElementById('quickTestEmail');
            const testEmail = emailInput.value.trim();
            
            if (!testEmail) {
                showNotification('‚ùå Digite um email v√°lido!', 'warning');
                emailInput.focus();
                return;
            }

            if (!emailConfig.enabled || !emailConfig.serviceId || !emailConfig.templateId || !emailConfig.publicKey) {
                showNotification('‚ùå Configure primeiro todos os campos acima!', 'warning');
                return;
            }

            // Show loading state
            const button = document.querySelector('button[onclick="quickTestEmail()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="mr-2">‚è≥</span>Enviando...';
            button.disabled = true;

            const testData = {
                to_email: testEmail,
                subject: '‚ö° Teste R√°pido - Dashboard de Carros',
                message: `Ol√°! üëã

Este √© um teste r√°pido do seu sistema de gest√£o de carros.

‚úÖ SUCESSO! A configura√ß√£o est√° funcionando perfeitamente!

Agora o sistema pode enviar alertas autom√°ticos para:
üìß Inspe√ß√µes pr√≥ximas do vencimento
üõ°Ô∏è Seguros a expirar  
üí∞ Pagamentos de IUC em atraso

üìÖ Teste realizado: ${new Date().toLocaleString('pt-PT')}
üìß Email testado: ${testEmail}

O sistema est√° pronto para uso! üöÄ

---
Dashboard de Carros - Sistema Autom√°tico`
            };

            sendEmailViaEmailJS(testData)
                .then(() => {
                    showNotification('üéâ Teste enviado com sucesso! Verifique a caixa de entrada.', 'info');
                    emailInput.value = '';
                    button.innerHTML = '<span class="mr-2">‚úÖ</span>Enviado!';
                    button.style.backgroundColor = '#16a34a';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = '';
                        button.disabled = false;
                    }, 3000);
                })
                .catch((error) => {
                    showNotification('‚ùå Erro no envio. Verifique a configura√ß√£o.', 'warning');
                    console.error('Quick test email error:', error);
                    button.innerHTML = '<span class="mr-2">‚ùå</span>Erro';
                    button.style.backgroundColor = '#dc2626';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = '';
                        button.disabled = false;
                    }, 3000);
                });
        }

        async function sendEmailViaEmailJS(emailData) {
            if (!emailConfig.enabled) {
                throw new Error('EmailJS not configured');
            }

            try {
                const response = await emailjs.send(
                    emailConfig.serviceId,
                    emailConfig.templateId,
                    emailData
                );
                console.log('Email sent successfully:', response);
                return response;
            } catch (error) {
                console.error('EmailJS error:', error);
                throw error;
            }
        }

        // JSONBin API functions
        async function saveToJSONBin(data) {
            if (!config.apiKey) {
                console.log('JSONBin n√£o configurado, usando localStorage');
                return;
            }

            try {
                const url = config.binId 
                    ? `https://api.jsonbin.io/v3/b/${config.binId}`
                    : 'https://api.jsonbin.io/v3/b';
                
                const method = config.binId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': config.apiKey,
                        'X-Bin-Name': 'carros-dashboard'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Dados salvos no JSONBin com sucesso');
                } else {
                    throw new Error('Erro ao salvar no JSONBin');
                }
            } catch (error) {
                console.error('Erro JSONBin:', error);
            }
        }

        async function loadFromJSONBin() {
            if (!config.apiKey || !config.binId) {
                return null;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${config.binId}/latest`, {
                    headers: {
                        'X-Master-Key': config.apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.record;
                } else {
                    throw new Error('Erro ao carregar do JSONBin');
                }
            } catch (error) {
                console.error('Erro ao carregar JSONBin:', error);
                return null;
            }
        }

        function saveCars() {
            localStorage.setItem('cars', JSON.stringify(cars));
            saveToJSONBin(cars);
        }

        async function loadCars() {
            if (config.apiKey && config.binId) {
                const cloudData = await loadFromJSONBin();
                if (cloudData) {
                    cars = cloudData;
                    localStorage.setItem('cars', JSON.stringify(cars));
                    return;
                }
            }
            // Fallback to localStorage
            cars = JSON.parse(localStorage.getItem('cars')) || [];
        }

        function getDaysUntil(dateString) {
            const today = new Date();
            const targetDate = new Date(dateString);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getStatusClass(days) {
            if (days < 0) return 'status-urgent';      // Vencido - vermelho
            if (days <= 7) return 'status-warning';    // Pr√≥ximo (7 dias) - amarelo
            if (days <= 30) return 'status-neutral';   // Aten√ß√£o (30 dias) - cinza
            return 'status-ok';                        // OK (mais de 30 dias) - verde
        }

        function getStatusText(days) {
            if (days < 0) return `Vencido h√° ${Math.abs(days)} dias`;
            if (days === 0) return 'Vence hoje';
            if (days === 1) return 'Vence amanh√£';
            return `${days} dias`;
        }

        function getBrandIcon(brand, carLogo = null) {
            // Check if car has a custom logo
            if (carLogo) {
                return `<img src="${carLogo}" alt="${brand}" class="w-8 h-8 object-contain rounded">`;
            }

            // Fallback to emoji icons
            const brandIcons = {
                'audi': 'üÖ∞Ô∏è',
                'bmw': 'üîµ',
                'mercedes': '‚≠ê',
                'volkswagen': 'üî∑',
                'ford': 'üîµ',
                'opel': '‚ö°',
                'peugeot': 'ü¶Å',
                'renault': 'üíé',
                'citroen': 'üî∫',
                'fiat': 'üáÆüáπ',
                'seat': 'üá™üá∏',
                'skoda': 'üçÄ',
                'toyota': 'üî¥',
                'honda': 'üÖ∑',
                'nissan': 'üîµ',
                'mazda': 'üåÄ',
                'hyundai': 'üÖ∑',
                'kia': 'üî¥',
                'volvo': 'üá∏üá™',
                'jaguar': 'üêÜ',
                'landrover': 'üü¢',
                'porsche': 'üèéÔ∏è',
                'mini': 'üîµ',
                'alfa': 'üêç',
                'jeep': 'üöô',
                'dacia': 'üî∑',
                'tesla': '‚ö°',
                'lexus': 'üî∂',
                'infiniti': '‚ôæÔ∏è',
                'acura': 'üÖ∞Ô∏è',
                'subaru': '‚≠ê',
                'mitsubishi': 'üî∫',
                'suzuki': 'üîµ',
                'isuzu': 'üî∑',
                'smart': 'üîµ',
                'ds': 'üíé',
                'lancia': 'üî∑',
                'saab': 'üá∏üá™'
            };
            
            return brandIcons[brand?.toLowerCase()] || 'üöó';
        }

        function getEventIcon(type) {
            switch(type) {
                case 'inspection': return 'üîß';
                case 'insurance': return 'üõ°Ô∏è';
                case 'iuc': return 'üí∞';
                default: return '‚ö†Ô∏è';
            }
        }

        function getEventName(type) {
            switch(type) {
                case 'inspection': return 'Inspe√ß√£o';
                case 'insurance': return 'Seguro';
                case 'iuc': return 'IUC';
                default: return 'Evento';
            }
        }

        function getAllEvents() {
            const events = [];
            
            cars.forEach((car, carIndex) => {
                const eventTypes = [
                    { type: 'inspection', date: car.inspectionDate },
                    { type: 'insurance', date: car.insuranceDate },
                    { type: 'iuc', date: car.iucDate }
                ];

                eventTypes.forEach(eventType => {
                    events.push({
                        carName: car.name,
                        licensePlate: car.licensePlate,
                        brand: car.brand,
                        alertEmail: car.alertEmail,
                        type: eventType.type,
                        date: eventType.date,
                        days: getDaysUntil(eventType.date)
                    });
                });
            });

            // Sort by date (closest first)
            events.sort((a, b) => a.days - b.days);
            return events;
        }

        function checkAlerts() {
            const events = getAllEvents();
            const alertEvents = events.filter(event => 
                (event.days === 30 || event.days === 15) && event.alertEmail
            );

            if (alertEvents.length > 0) {
                console.log(`Enviando ${alertEvents.length} alertas autom√°ticos...`);
                alertEvents.forEach(event => {
                    sendEmailAlert(event);
                });
            }
        }

        async function sendEmailAlert(event) {
            if (!event.alertEmail) {
                showNotification('Email n√£o configurado para este ve√≠culo!', 'info');
                return;
            }

            const eventName = getEventName(event.type);
            const subject = `üö® Alerta: ${eventName} - ${event.carName} (${event.licensePlate})`;
            
            let message = '';
            if (event.days === 30) {
                message = `Caro(a) propriet√°rio(a),

Este √© um lembrete de que falta exatamente 1 M√äS para o vencimento do ${eventName.toLowerCase()} do seu ve√≠culo:

`;
            } else if (event.days === 15) {
                message = `Caro(a) propriet√°rio(a),

‚ö†Ô∏è ATEN√á√ÉO: Faltam apenas 15 DIAS para o vencimento do ${eventName.toLowerCase()} do seu ve√≠culo:

`;
            } else if (event.days === 7) {
                message = `Caro(a) propriet√°rio(a),

üö® URGENTE: Falta apenas 1 SEMANA para o vencimento do ${eventName.toLowerCase()} do seu ve√≠culo:

`;
            } else if (event.days === 1) {
                message = `Caro(a) propriet√°rio(a),

üö® MUITO URGENTE: O ${eventName.toLowerCase()} do seu ve√≠culo vence AMANH√É:

`;
            } else if (event.days === 0) {
                message = `Caro(a) propriet√°rio(a),

üö® CR√çTICO: O ${eventName.toLowerCase()} do seu ve√≠culo vence HOJE:

`;
            } else {
                message = `Caro(a) propriet√°rio(a),

Lembrete sobre o ${eventName.toLowerCase()} do seu ve√≠culo:

`;
            }
            
            message += `üöó Ve√≠culo: ${event.carName}
üìã Matr√≠cula: ${event.licensePlate}
üìÖ Data de vencimento: ${formatDate(event.date)}
‚è∞ Dias restantes: ${event.days}

`;
            
            switch(event.type) {
                case 'inspection':
                    message += `Por favor, agende a inspe√ß√£o peri√≥dica obrigat√≥ria do seu ve√≠culo o mais breve poss√≠vel para evitar multas e problemas legais.

`;
                    break;
                case 'insurance':
                    message += `Por favor, proceda √† renova√ß√£o do seguro autom√≥vel para evitar ficar sem cobertura e circular ilegalmente.

`;
                    break;
                case 'iuc':
                    message += `Por favor, efetue o pagamento do Imposto √önico de Circula√ß√£o (IUC) para evitar multas e apreens√£o do ve√≠culo.

`;
                    break;
            }
            
            message += `Este √© um lembrete autom√°tico do seu Dashboard de Carros.

Cumprimentos,
Sistema de Gest√£o de Carros`;

            // Try to send via EmailJS first, fallback to manual method
            if (emailConfig.enabled) {
                try {
                    await sendEmailViaEmailJS({
                        to_email: event.alertEmail,
                        subject: subject,
                        message: message
                    });
                    showNotification(`‚úÖ Email enviado automaticamente para ${event.alertEmail}!`, 'info');
                    return;
                } catch (error) {
                    console.error('EmailJS failed, falling back to manual method:', error);
                    showNotification('‚ö†Ô∏è Falha no envio autom√°tico. Abrindo m√©todo manual...', 'warning');
                }
            }

            // Fallback to manual method
            showEmailModal(event.alertEmail, subject, message);
        }

        function showEmailModal(email, subject, message) {
            const modal = document.createElement('div');
            modal.className = 'confirm-modal show';
            
            modal.innerHTML = `
                <div class="glass-card rounded-3xl p-8 max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                            <span class="text-3xl">üìß</span>
                        </div>
                        <h3 class="text-xl font-bold text-slate-700 mb-2">Email de Alerta Preparado</h3>
                        <p class="text-slate-500">Copie o conte√∫do e cole no seu cliente de email</p>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-xl mb-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìß Para:</label>
                                <input type="text" value="${email}" readonly class="w-full p-3 bg-white border rounded-lg text-sm font-mono" onclick="this.select()">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìã Assunto:</label>
                                <input type="text" value="${subject}" readonly class="w-full p-3 bg-white border rounded-lg text-sm font-mono" onclick="this.select()">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üí¨ Mensagem:</label>
                            <textarea readonly class="w-full h-48 p-3 bg-white border rounded-lg text-sm font-mono resize-none" onclick="this.select()">${message}</textarea>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="tryMailtoLink('${email}', '${encodeURIComponent(subject)}', '${encodeURIComponent(message)}')" class="bg-green-100 hover:bg-green-200 text-green-700 font-semibold py-3 px-4 rounded-xl transition-all duration-300">
                            üìß Abrir Email
                        </button>
                        <button onclick="copyEmailContent('${email}', '${subject.replace(/'/g, "\\'")}', \`${message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-3 px-4 rounded-xl transition-all duration-300">
                            üìã Copiar Tudo
                        </button>
                        <button onclick="this.closest('.confirm-modal').remove()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl transition-all duration-300">
                            ‚úñÔ∏è Fechar
                        </button>
                    </div>
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                        <p class="text-sm text-blue-700">
                            <strong>üí° Dica:</strong> Configure o "Email Autom√°tico" para envios sem interven√ß√£o manual!
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function tryMailtoLink(email, encodedSubject, encodedMessage) {
            try {
                const mailtoUrl = `mailto:${email}?subject=${encodedSubject}&body=${encodedMessage}`;
                window.open(mailtoUrl, '_blank');
                showNotification('Cliente de email aberto! Verifique se o email foi criado.', 'info');
            } catch (error) {
                showNotification('N√£o foi poss√≠vel abrir o cliente de email. Use "Copiar Tudo".', 'info');
            }
        }

        function copyEmailContent(email, subject, message) {
            const fullContent = `Para: ${email}
Assunto: ${subject}

${message}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullContent).then(() => {
                    showNotification('‚úÖ Email copiado! Cole no seu cliente de email.', 'info');
                }).catch(() => {
                    fallbackCopy(fullContent);
                });
            } else {
                fallbackCopy(fullContent);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('‚úÖ Email copiado! Cole no seu cliente de email.', 'info');
            } catch (err) {
                showNotification('‚ùå Erro ao copiar. Selecione e copie manualmente.', 'info');
            }
            
            document.body.removeChild(textArea);
        }

        function showNotification(message, type = 'info', onClick = null) {
            // Remove existing notifications
            const existing = document.querySelector('.alert-notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'alert-notification';
            
            let bgColor = '#fbbf24';
            let textColor = '#92400e';
            let borderColor = '#f59e0b';
            
            if (type === 'info') {
                bgColor = '#60a5fa';
                textColor = '#1e40af';
                borderColor = '#3b82f6';
            }
            
            notification.style.background = bgColor;
            notification.style.color = textColor;
            notification.style.borderLeftColor = borderColor;
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-lg mr-3">${type === 'info' ? '‚ÑπÔ∏è' : '‚ö†Ô∏è'}</span>
                        <span class="font-semibold">${message}</span>
                    </div>
                    ${onClick ? '<button class="ml-4 bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm font-semibold">Enviar</button>' : ''}
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-lg hover:opacity-70">√ó</button>
                </div>
            `;
            
            if (onClick) {
                notification.querySelector('button').addEventListener('click', onClick);
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function renderDashboard() {
            const eventsTimeline = document.getElementById('eventsTimeline');
            const events = getAllEvents();

            if (events.length === 0) {
                eventsTimeline.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-6">üìÖ</div>
                        <p class="text-gray-500 text-lg">Nenhum evento encontrado. Adicione carros para ver os pr√≥ximos eventos.</p>
                    </div>
                `;
                return;
            }

            let currentMonth = '';
            let timelineHTML = '';

            events.forEach((event, index) => {
                const eventDate = new Date(event.date);
                const monthYear = eventDate.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                
                // Add month separator
                if (monthYear !== currentMonth) {
                    currentMonth = monthYear;
                    timelineHTML += `
                        <div class="flex items-center mb-6 ${index > 0 ? 'mt-10' : ''}">
                            <div class="flex-1 h-px bg-gray-300"></div>
                            <span class="px-6 py-2 text-sm font-bold text-gray-600 bg-gray-100 rounded-full">${monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}</span>
                            <div class="flex-1 h-px bg-gray-300"></div>
                        </div>
                    `;
                }

                const statusClass = getStatusClass(event.days);
                const statusText = getStatusText(event.days);
                
                timelineHTML += `
                    <div class="p-4 mb-4 rounded-2xl ${statusClass} card-hover">
                        <!-- Mobile Layout -->
                        <div class="block md:hidden">
                            <div class="flex items-start space-x-3 mb-4">
                                <div class="bg-white/30 p-2 rounded-lg flex-shrink-0 flex items-center justify-center w-12 h-12">
                                    ${getBrandIcon(event.brand, cars.find(c => c.licensePlate === event.licensePlate)?.logo)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-base leading-tight mb-1">${event.carName}</h3>
                                    <p class="opacity-80 font-medium text-sm leading-tight">${event.licensePlate}</p>
                                    <p class="opacity-90 font-medium text-sm text-current">${getEventIcon(event.type)} ${getEventName(event.type)}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-white/20">
                                <div class="flex-1">
                                    <div class="font-semibold text-base mb-1">${formatDate(event.date)}</div>
                                    <div class="opacity-90 font-medium text-sm">${statusText}</div>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0 ml-3">
                                    <button onclick="addToGoogleCalendar(event, ${index})" class="bg-white/40 hover:bg-white/60 text-gray-700 w-10 h-10 rounded-lg transition-all duration-200 flex items-center justify-center">
                                        <span class="text-lg">üìÖ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Desktop Layout -->
                        <div class="hidden md:flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="bg-white/20 p-3 rounded-lg flex items-center justify-center w-16 h-16">
                                    ${getBrandIcon(event.brand, cars.find(c => c.licensePlate === event.licensePlate)?.logo)}
                                </div>
                                <div>
                                    <div class="flex items-center space-x-3 mb-1">
                                        <h3 class="font-semibold text-lg">${event.carName}</h3>
                                        <span class="opacity-60">‚Ä¢</span>
                                        <span class="opacity-90 font-medium text-sm">${event.licensePlate}</span>
                                    </div>
                                    <p class="opacity-90 font-medium text-sm">${getEventIcon(event.type)} ${getEventName(event.type)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button onclick="addToGoogleCalendar(event, ${index})" class="bg-white/40 hover:bg-white/60 text-gray-700 w-12 h-12 rounded-lg transition-all duration-200 flex items-center justify-center">
                                    <span class="text-xl">üìÖ</span>
                                </button>
                                <div class="text-right">
                                    <div class="font-semibold text-base">${formatDate(event.date)}</div>
                                    <div class="opacity-90 font-medium text-sm">${statusText}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            eventsTimeline.innerHTML = timelineHTML;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-PT');
        }

        function addToGoogleCalendar(e, index) {
            e.preventDefault();
            e.stopPropagation();
            
            const events = getAllEvents();
            const event = events[index];
            
            const eventName = getEventName(event.type);
            const title = `${eventName} - ${event.carName} (${event.licensePlate})`;
            
            // Create description based on event type
            let description = '';
            switch(event.type) {
                case 'inspection':
                    description = `Inspe√ß√£o peri√≥dica obrigat√≥ria do ve√≠culo ${event.carName} com matr√≠cula ${event.licensePlate}.`;
                    break;
                case 'insurance':
                    description = `Renova√ß√£o do seguro autom√≥vel do ve√≠culo ${event.carName} com matr√≠cula ${event.licensePlate}.`;
                    break;
                case 'iuc':
                    description = `Pagamento do Imposto √önico de Circula√ß√£o (IUC) do ve√≠culo ${event.carName} com matr√≠cula ${event.licensePlate}.`;
                    break;
            }

            // Format date for Google Calendar (YYYYMMDD)
            const date = new Date(event.date);
            const formattedDate = date.toISOString().slice(0, 10).replace(/-/g, '');
            
            // Create Google Calendar URL
            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formattedDate}/${formattedDate}&details=${encodeURIComponent(description)}&location=${encodeURIComponent('Portugal')}&sf=true&output=xml`;
            
            // Open in new tab
            window.open(googleCalendarUrl, '_blank', 'noopener,noreferrer');
        }

        function renderCars() {
            const carsList = document.getElementById('carsList');

            if (cars.length === 0) {
                carsList.innerHTML = '';
                return;
            }
            
            carsList.innerHTML = cars.map((car, index) => {
                const inspectionDays = getDaysUntil(car.inspectionDate);
                const insuranceDays = getDaysUntil(car.insuranceDate);
                const iucDays = getDaysUntil(car.iucDate);

                return `
                    <div class="glass-card rounded-3xl p-6 card-hover">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="bg-slate-100 p-3 rounded-xl flex items-center justify-center w-16 h-16">
                                    ${getBrandIcon(car.brand, car.logo)}
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-slate-700 mb-1">${car.name}</h3>
                                    <p class="text-slate-500 font-medium text-base">${car.licensePlate}</p>
                                    ${car.alertEmail ? `<p class="text-slate-400 text-sm">üìß ${car.alertEmail}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 rounded-xl ${getStatusClass(inspectionDays)}">
                                <div>
                                    <span class="font-semibold text-base">üîß Inspe√ß√£o</span>
                                    <p class="opacity-80 font-medium text-sm">${formatDate(car.inspectionDate)}</p>
                                </div>
                                <span class="font-semibold text-sm">${getStatusText(inspectionDays)}</span>
                            </div>

                            <div class="flex justify-between items-center p-3 rounded-xl ${getStatusClass(insuranceDays)}">
                                <div>
                                    <span class="font-semibold text-base">üõ°Ô∏è Seguro</span>
                                    <p class="opacity-80 font-medium text-sm">${formatDate(car.insuranceDate)}</p>
                                </div>
                                <span class="font-semibold text-sm">${getStatusText(insuranceDays)}</span>
                            </div>

                            <div class="flex justify-between items-center p-3 rounded-xl ${getStatusClass(iucDays)}">
                                <div>
                                    <span class="font-semibold text-base">üí∞ IUC</span>
                                    <p class="opacity-80 font-medium text-sm">${formatDate(car.iucDate)}</p>
                                </div>
                                <span class="font-semibold text-sm">${getStatusText(iucDays)}</span>
                            </div>
                        </div>

                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <button onclick="editCar(${index})" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:scale-105">
                                <span class="text-lg mr-2">‚úèÔ∏è</span>Editar
                            </button>
                            <button onclick="deleteCar(${index})" class="bg-red-100 hover:bg-red-200 text-red-700 font-bold py-3 px-4 rounded-xl transition-all duration-300 hover:scale-105">
                                <span class="text-lg mr-2">üóëÔ∏è</span>Apagar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDashboard() {
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('carsView').style.display = 'none';
            document.getElementById('emailConfigView').style.display = 'none';
            document.getElementById('configView').style.display = 'none';
            document.getElementById('emptyState').style.display = cars.length === 0 ? 'block' : 'none';
            
            document.getElementById('dashboardBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 bg-slate-200 text-slate-700 shadow-sm';
            document.getElementById('carsBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            
            renderDashboard();
        }

        function showCars() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('carsView').style.display = 'block';
            document.getElementById('emailConfigView').style.display = 'none';
            document.getElementById('configView').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            document.getElementById('dashboardBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100';
            document.getElementById('carsBtn').className = 'px-6 py-3 rounded-xl font-semibold transition-all duration-300 bg-slate-200 text-slate-700 shadow-sm';
            
            renderCars();
        }

        let carToDelete = null;

        function deleteCar(index) {
            carToDelete = index;
            const car = cars[index];
            document.getElementById('confirmMessage').textContent = `Tem a certeza que deseja eliminar o ${car.name} (${car.licensePlate})?`;
            document.getElementById('confirmModal').classList.add('show');
        }

        function cancelDelete() {
            carToDelete = null;
            document.getElementById('confirmModal').classList.remove('show');
        }

        function confirmDelete() {
            if (carToDelete !== null) {
                cars.splice(carToDelete, 1);
                saveCars();
                renderCars();
                renderDashboard();
                
                // If no cars left, show empty state
                if (cars.length === 0) {
                    showDashboard();
                }
                
                carToDelete = null;
                document.getElementById('confirmModal').classList.remove('show');
            }
        }

        function editCar(index) {
            const car = cars[index];
            document.getElementById('carBrand').value = car.brand || '';
            document.getElementById('carModel').value = car.model || '';
            document.getElementById('licensePlate').value = car.licensePlate;
            document.getElementById('alertEmail').value = car.alertEmail || '';
            document.getElementById('inspectionDate').value = car.inspectionDate;
            document.getElementById('insuranceDate').value = car.insuranceDate;
            document.getElementById('iucDate').value = car.iucDate;

            // Handle logo display and form fields
            const logoPreview = document.getElementById('logoPreview');
            const logoUrlInput = document.getElementById('logoUrl');
            const logoFileInput = document.getElementById('brandLogo');
            
            // Clear inputs first
            logoUrlInput.value = '';
            logoFileInput.value = '';
            
            if (car.logo) {
                // Check if logo is a URL or base64
                if (car.logo.startsWith('http://') || car.logo.startsWith('https://')) {
                    // It's a URL
                    logoUrlInput.value = car.logo;
                }
                // Show preview regardless of type
                logoPreview.innerHTML = `<img src="${car.logo}" alt="Logo" class="w-full h-full object-contain rounded">`;
                logoPreview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden';
            } else {
                logoPreview.innerHTML = 'Logo';
                logoPreview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-xs';
            }

            // Store the index for editing
            document.getElementById('carForm').dataset.editIndex = index;

            // Change button text to indicate editing
            const submitButton = document.querySelector('#carForm button[type="submit"]');
            submitButton.innerHTML = '<span class="text-lg mr-2">‚úèÔ∏è</span>Atualizar Carro';

            // Scroll to form
            document.getElementById('carForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Logo preview functionality
        document.getElementById('logoUrl').addEventListener('input', function(e) {
            const url = e.target.value.trim();
            const preview = document.getElementById('logoPreview');
            
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                preview.innerHTML = `<img src="${url}" alt="Logo Preview" class="w-full h-full object-contain rounded" onerror="this.parentElement.innerHTML='‚ùå'; this.parentElement.className='w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center text-red-500 text-xs';">`;
                preview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden';
                // Clear file input when URL is used
                document.getElementById('brandLogo').value = '';
            } else if (url === '') {
                preview.innerHTML = 'Logo';
                preview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-xs';
            }
        });

        document.getElementById('brandLogo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('logoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Logo Preview" class="w-full h-full object-contain rounded">`;
                    preview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden';
                };
                reader.readAsDataURL(file);
                // Clear URL input when file is selected
                document.getElementById('logoUrl').value = '';
            } else {
                preview.innerHTML = 'Logo';
                preview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-xs';
            }
        });

        document.getElementById('carForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const brand = document.getElementById('carBrand').value;
            const model = document.getElementById('carModel').value;
            const carName = `${brand} ${model}`;
            const editIndex = this.dataset.editIndex;
            
            // Base car data
            const carData = {
                name: carName,
                brand: brand,
                model: model,
                licensePlate: document.getElementById('licensePlate').value,
                alertEmail: document.getElementById('alertEmail').value,
                inspectionDate: document.getElementById('inspectionDate').value,
                insuranceDate: document.getElementById('insuranceDate').value,
                iucDate: document.getElementById('iucDate').value,
                logo: null
            };

            // If editing, preserve existing logo first
            if (editIndex !== undefined && cars[parseInt(editIndex)]) {
                carData.logo = cars[parseInt(editIndex)].logo || null;
            }

            // Check for URL logo first
            const logoUrl = document.getElementById('logoUrl').value.trim();
            const logoFile = document.getElementById('brandLogo').files[0];
            
            if (logoUrl && (logoUrl.startsWith('http://') || logoUrl.startsWith('https://'))) {
                // Use URL logo
                carData.logo = logoUrl;
                console.log('Using URL logo:', logoUrl);
                saveCarData(carData, editIndex);
            } else if (logoFile) {
                // Use file logo
                console.log('Processing new logo file...');
                const reader = new FileReader();
                reader.onload = function(e) {
                    carData.logo = e.target.result;
                    console.log('New logo processed, size:', e.target.result.length);
                    saveCarData(carData, editIndex);
                };
                reader.readAsDataURL(logoFile);
            } else {
                console.log('No new logo, using existing:', carData.logo ? 'Yes' : 'No');
                saveCarData(carData, editIndex);
            }
        });

        function saveCarData(carData, editIndex) {
            const button = document.querySelector('#carForm button[type="submit"]');
            const form = document.getElementById('carForm');
            
            console.log('Saving car data:', {
                name: carData.name,
                email: carData.alertEmail,
                hasLogo: !!carData.logo,
                logoSize: carData.logo ? carData.logo.length : 0
            });
            
            if (editIndex !== undefined) {
                // Editing existing car
                cars[parseInt(editIndex)] = carData;
                button.textContent = 'Carro Atualizado!';
                delete form.dataset.editIndex;
                console.log('Updated car at index:', editIndex);
            } else {
                // Adding new car
                cars.push(carData);
                button.textContent = 'Carro Adicionado!';
                console.log('Added new car, total cars:', cars.length);
            }

            // Save to storage
            saveCars();
            
            // Update displays
            renderCars();
            renderDashboard();

            // Clear form and logo preview
            form.reset();
            document.getElementById('logoUrl').value = '';
            document.getElementById('brandLogo').value = '';
            const logoPreview = document.getElementById('logoPreview');
            logoPreview.innerHTML = 'Logo';
            logoPreview.className = 'w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400 text-xs';
            
            // Show success message
            button.style.backgroundColor = '#16a34a';
            button.style.color = 'white';
            
            setTimeout(() => {
                button.innerHTML = '<span class="text-lg mr-2">üöó</span>Adicionar Carro';
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 2000);
        }

        // Auto-check for alerts every hour
        setInterval(checkAlerts, 3600000); // 1 hour = 3600000ms

        // Initialize app
        async function initApp() {
            await loadCars();
            initEmailJS();
            showDashboard();
            // Check for alerts on startup
            setTimeout(checkAlerts, 2000);
        }

        // Initial render
        initApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ad0b8e6104e3b0',t:'MTc1OTgzNjQwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
